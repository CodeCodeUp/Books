# å›¾ä¹¦æ¨èç³»ç»Ÿç®—æ³•è¯¦è§£

## ğŸ“– æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å›¾ä¹¦æ¨èç³»ç»Ÿä¸­ä½¿ç”¨çš„æ‰€æœ‰æ¨èç®—æ³•ï¼ŒåŒ…æ‹¬å®ç°åŸç†ã€æ•°å­¦æ¨¡å‹ã€ä»£ç é€»è¾‘å’Œåº”ç”¨åœºæ™¯ã€‚é€‚åˆæŠ€æœ¯äººå‘˜æ·±å…¥ç†è§£æ¨èç³»ç»Ÿçš„å·¥ä½œæœºåˆ¶ã€‚

## ğŸ¯ ç³»ç»Ÿç®—æ³•æ¶æ„æ€»è§ˆ

### ç®—æ³•åˆ†å¸ƒå›¾

```
å›¾ä¹¦æ¨èç³»ç»Ÿ
â”œâ”€â”€ æ¨èé¡µé¢
â”‚   â””â”€â”€ æ··åˆæ¨èç®—æ³• (7:3)
â”‚       â”œâ”€â”€ ç”¨æˆ·ååŒè¿‡æ»¤ (70%)  â† ä¸»åŠ›ç®—æ³•
â”‚       â””â”€â”€ å†…å®¹ç‰¹å¾æ¨è (30%)  â† è¡¥å……ç®—æ³•
â”œâ”€â”€ å›¾ä¹¦è¯¦æƒ…é¡µ  
â”‚   â””â”€â”€ æ··åˆç›¸ä¼¼å›¾ä¹¦æ¨è (7:3)
â”‚       â”œâ”€â”€ ç‰©å“ååŒè¿‡æ»¤ (70%)  â† ä¸»åŠ›ç®—æ³•
â”‚       â””â”€â”€ å†…å®¹ç‰¹å¾ç›¸ä¼¼ (30%)  â† è¡¥å……ç®—æ³•
â””â”€â”€ é™çº§ç­–ç•¥
    â”œâ”€â”€ æ–°ç”¨æˆ· â†’ åŸºäºç”¨æˆ·ç‰¹å¾æ¨è
    â”œâ”€â”€ æ— ç‰¹å¾ â†’ ä¼˜è´¨çƒ­é—¨å›¾ä¹¦
    â””â”€â”€ ç®—æ³•å¤±è´¥ â†’ åŒä½œè€…å›¾ä¹¦
```

## ğŸ“Š ç®—æ³•è¯¦ç»†ä»‹ç»

### 1. ç”¨æˆ·ååŒè¿‡æ»¤ç®—æ³• (User-Based Collaborative Filtering)

#### ğŸ¯ æ ¸å¿ƒæ€æƒ³
**"æ‰¾åˆ°ä¸ä½ å…´è¶£ç›¸ä¼¼çš„ç”¨æˆ·ï¼Œæ¨èä»–ä»¬å–œæ¬¢ä½†ä½ è¿˜æ²¡è¯»è¿‡çš„å›¾ä¹¦"**

#### ğŸ“š åº”ç”¨åœºæ™¯
- **ä½ç½®**: æ¨èé¡µé¢çš„ä¸ªæ€§åŒ–æ¨è
- **ç›®æ ‡**: å¸®åŠ©ç”¨æˆ·å‘ç°æ–°çš„å›¾ä¹¦ç±»å‹å’Œä½œè€…
- **ä¼˜åŠ¿**: èƒ½æ¨èç”¨æˆ·æ„æƒ³ä¸åˆ°çš„ä¼˜è´¨å›¾ä¹¦

#### ğŸ§® æ•°å­¦åŸç†

##### ç›¸ä¼¼åº¦è®¡ç®— - ä½™å¼¦ç›¸ä¼¼åº¦
```
è®¾ç”¨æˆ·Aå’Œç”¨æˆ·Bå¯¹å…±åŒè¯„åˆ†å›¾ä¹¦çš„è¯„åˆ†å‘é‡åˆ†åˆ«ä¸ºï¼š
user_A = [r_A1, r_A2, ..., r_An]
user_B = [r_B1, r_B2, ..., r_Bn]

ä½™å¼¦ç›¸ä¼¼åº¦å…¬å¼ï¼š
similarity(A,B) = cos(Î¸) = (AÂ·B) / (||A|| Ã— ||B||)

å…¶ä¸­ï¼š
AÂ·B = Î£(r_Ai Ã— r_Bi)  # å‘é‡ç‚¹ç§¯
||A|| = âˆš(Î£(r_AiÂ²))   # å‘é‡Açš„é•¿åº¦
||B|| = âˆš(Î£(r_BiÂ²))   # å‘é‡Bçš„é•¿åº¦
```

##### è¯„åˆ†é¢„æµ‹ - åŠ æƒå¹³å‡
```
é¢„æµ‹ç”¨æˆ·uå¯¹å›¾ä¹¦içš„è¯„åˆ†ï¼š
predicted_rating(u,i) = Î£(similarity(u,v) Ã— rating(v,i)) / Î£|similarity(u,v)|

å…¶ä¸­ï¼š
v âˆˆ ä¸ç”¨æˆ·uç›¸ä¼¼ä¸”è¯„åˆ†è¿‡å›¾ä¹¦içš„ç”¨æˆ·é›†åˆ
similarity(u,v) âˆˆ [0,1] ä¸ºç”¨æˆ·ç›¸ä¼¼åº¦
```

#### ğŸ’» ä»£ç å®ç°é€»è¾‘

##### ç¬¬ä¸€æ­¥ï¼šæ‰¾ç›¸ä¼¼ç”¨æˆ·
```python
def find_similar_users_efficient(self, target_user_id):
    # 1. è·å–ç›®æ ‡ç”¨æˆ·çš„è¯„åˆ†è®°å½•
    target_ratings = ratings_df[ratings_df['user_id'] == target_user_id]
    target_books = set(target_ratings['book_id'].values)
    
    # 2. æ‰¾è¯„åˆ†è¿‡ç›¸åŒå›¾ä¹¦çš„å…¶ä»–ç”¨æˆ·
    common_users = ratings_df[
        ratings_df['book_id'].isin(target_books) & 
        (ratings_df['user_id'] != target_user_id)
    ]
    
    # 3. è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆè‡³å°‘2æœ¬å…±åŒå›¾ä¹¦ï¼‰
    for other_user_id in qualified_users:
        similarity = calculate_cosine_similarity(target_user, other_user)
        if similarity > 0.3:  # ç›¸ä¼¼åº¦é˜ˆå€¼
            similar_users.append(other_user_id, similarity)
```

##### ç¬¬äºŒæ­¥ï¼šé¢„æµ‹è¯„åˆ†
```python
def predict_rating(self, user_id, book_id, similar_users):
    weighted_sum = 0.0
    similarity_sum = 0.0
    
    for similar_user, similarity in similar_users:
        if similar_user_rated_this_book:
            weighted_sum += similarity * similar_user_rating
            similarity_sum += similarity
    
    return weighted_sum / similarity_sum if similarity_sum > 0 else 0
```

##### ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæ¨è
```python
def generate_recommendations(self, user_id, similar_users):
    # 1. æ”¶é›†å€™é€‰å›¾ä¹¦ï¼ˆç›¸ä¼¼ç”¨æˆ·çš„é«˜åˆ†å›¾ä¹¦ï¼‰
    candidate_books = {}
    for similar_user in similar_users[:20]:  # å‰20ä¸ªæœ€ç›¸ä¼¼ç”¨æˆ·
        high_rated_books = è¯¥ç”¨æˆ·è¯„åˆ† >= 3.0çš„å›¾ä¹¦
        for book in high_rated_books:
            if book not in user_already_rated:
                candidate_books[book].append(rating, similarity)
    
    # 2. é¢„æµ‹è¯„åˆ†å¹¶æ’åº
    predictions = []
    for book_id, ratings_data in candidate_books.items():
        predicted_rating = åŠ æƒå¹³å‡(ratings_data)
        if predicted_rating >= min_rating:
            predictions.append(book_id, predicted_rating)
    
    # 3. è¿”å›Top-Næ¨è
    return sorted(predictions, reverse=True)[:top_n]
```

#### âš¡ æ€§èƒ½ä¼˜åŒ–

##### å€™é€‰ç”¨æˆ·é¢„ç­›é€‰
```python
# ä¼˜åŒ–å‰ï¼šè®¡ç®—ä¸æ‰€æœ‰7ä¸‡ç”¨æˆ·çš„ç›¸ä¼¼åº¦ - æ€§èƒ½ç¾éš¾
for user in all_77k_users:
    similarity = calculate_similarity(target_user, user)

# ä¼˜åŒ–åï¼šåªè®¡ç®—æœ‰å…±åŒè¯„åˆ†å›¾ä¹¦çš„ç”¨æˆ·
common_users = è¯„åˆ†è¿‡ç›¸åŒå›¾ä¹¦çš„ç”¨æˆ·  # é€šå¸¸å‡ åƒä¸ª
for user in common_users:
    similarity = calculate_similarity(target_user, user)
```

##### æ™ºèƒ½ç¼“å­˜æœºåˆ¶
```python
# 1. è¯„åˆ†åæ¸…é™¤ç¼“å­˜
ç”¨æˆ·è¯„åˆ† â†’ clearCache(user_id) â†’ precompute_async(user_id)

# 2. è®¿é—®æ¨èæ—¶
if cache_exists and not_expired:
    return cached_recommendations  # <1ç§’å“åº”
else:
    compute_and_cache()  # <30ç§’è®¡ç®—
```

### 2. ç‰©å“ååŒè¿‡æ»¤ç®—æ³• (Item-Based Collaborative Filtering)

#### ğŸ¯ æ ¸å¿ƒæ€æƒ³
**"å¦‚æœä¸¤æœ¬å›¾ä¹¦è¢«ç”¨æˆ·ä»¥ç›¸ä¼¼çš„æ–¹å¼è¯„åˆ†ï¼Œé‚£ä¹ˆå®ƒä»¬å°±æ˜¯ç›¸ä¼¼çš„å›¾ä¹¦"**

#### ğŸ“š åº”ç”¨åœºæ™¯
- **ä½ç½®**: å›¾ä¹¦è¯¦æƒ…é¡µçš„"å–œæ¬¢è¿™æœ¬ä¹¦çš„ç”¨æˆ·ä¹Ÿå–œæ¬¢"
- **ç›®æ ‡**: å¸®åŠ©ç”¨æˆ·å‘ç°ä¸å½“å‰å›¾ä¹¦ç›¸ä¼¼çš„å…¶ä»–å›¾ä¹¦
- **ä¼˜åŠ¿**: æ¨èç»“æœç¨³å®šï¼Œè§£é‡Šæ€§å¼º

#### ğŸ§® æ•°å­¦åŸç†

##### å›¾ä¹¦ç›¸ä¼¼åº¦è®¡ç®—
```
è®¾å›¾ä¹¦Aå’Œå›¾ä¹¦Bè¢«å…±åŒç”¨æˆ·çš„è¯„åˆ†å‘é‡åˆ†åˆ«ä¸ºï¼š
book_A = [r_1A, r_2A, ..., r_nA]  # nä¸ªç”¨æˆ·å¯¹å›¾ä¹¦Açš„è¯„åˆ†
book_B = [r_1B, r_2B, ..., r_nB]  # ç›¸åŒnä¸ªç”¨æˆ·å¯¹å›¾ä¹¦Bçš„è¯„åˆ†

å›¾ä¹¦ç›¸ä¼¼åº¦ï¼š
similarity(A,B) = cos(Î¸) = (AÂ·B) / (||A|| Ã— ||B||)
```

##### ä¸¾ä¾‹è¯´æ˜
```
å›¾ä¹¦ã€Šå“ˆåˆ©æ³¢ç‰¹ã€‹: [ç”¨æˆ·1=5åˆ†, ç”¨æˆ·2=4åˆ†, ç”¨æˆ·3=5åˆ†]
å›¾ä¹¦ã€ŠæŒ‡ç¯ç‹ã€‹:   [ç”¨æˆ·1=5åˆ†, ç”¨æˆ·2=4åˆ†, ç”¨æˆ·3=4åˆ†]

è®¡ç®—è¿‡ç¨‹ï¼š
ç‚¹ç§¯ = 5Ã—5 + 4Ã—4 + 5Ã—4 = 25 + 16 + 20 = 61
||å“ˆåˆ©æ³¢ç‰¹|| = âˆš(5Â² + 4Â² + 5Â²) = âˆš66 = 8.12
||æŒ‡ç¯ç‹|| = âˆš(5Â² + 4Â² + 4Â²) = âˆš57 = 7.55

ç›¸ä¼¼åº¦ = 61 / (8.12 Ã— 7.55) = 61 / 61.31 = 0.995 (é«˜åº¦ç›¸ä¼¼)
```

#### ğŸ’» ä»£ç å®ç°é€»è¾‘

##### ç¬¬ä¸€æ­¥ï¼šå€™é€‰å›¾ä¹¦é¢„ç­›é€‰ (æ€§èƒ½å…³é”®)
```python
def get_similar_books_for_item(self, target_book_id):
    # è·å–è¯„åˆ†è¿‡ç›®æ ‡å›¾ä¹¦çš„ç”¨æˆ·
    target_users = ratings[book_id == target_book_id]['user_id']
    
    # æ‰¾è¿™äº›ç”¨æˆ·è¿˜è¯„åˆ†è¿‡å“ªäº›å›¾ä¹¦ï¼ˆå€™é€‰é›†ï¼‰
    candidate_books = ratings[user_id.isin(target_users)]['book_id'].unique()
    
    # æ€§èƒ½æå‡ï¼šä»23ä¸‡æœ¬ â†’ å‡ åƒæœ¬å€™é€‰
    logger.info(f"å€™é€‰å›¾ä¹¦: {len(candidate_books)} æœ¬ï¼ˆä»23ä¸‡æœ¬ç­›é€‰ï¼‰")
```

##### ç¬¬äºŒæ­¥ï¼šæ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—
```python
# æŒ‰å€™é€‰å›¾ä¹¦åˆ†ç»„ï¼Œé¿å…é‡å¤æŸ¥è¯¢
candidate_ratings_grouped = candidate_ratings.groupby('book_id')

for other_book_id, other_book_ratings in candidate_ratings_grouped:
    # ç›´æ¥ä½¿ç”¨åˆ†ç»„æ•°æ®ï¼Œæ— éœ€é‡å¤è¿‡æ»¤
    common_users = target_users & set(other_book_ratings['user_id'])
    
    if len(common_users) >= 2:  # è‡³å°‘2ä¸ªå…±åŒç”¨æˆ·
        similarity = calculate_cosine_similarity(target_vector, other_vector)
```

##### æ€§èƒ½å¯¹æ¯”
```
ä¼˜åŒ–å‰ï¼š23ä¸‡æœ¬å›¾ä¹¦ Ã— ç›¸ä¼¼åº¦è®¡ç®— = 30åˆ†é’Ÿ+
ä¼˜åŒ–åï¼šå‡ åƒæœ¬å€™é€‰ Ã— æ‰¹é‡è®¡ç®— = å‡ ç§’é’Ÿ âœ…
```

### 3. å†…å®¹ç‰¹å¾æ¨èç®—æ³• (Content-Based Filtering)

#### ğŸ¯ æ ¸å¿ƒæ€æƒ³
**"åŸºäºå›¾ä¹¦çš„å†…å®¹ç‰¹å¾å’Œç”¨æˆ·çš„å…´è¶£ç‰¹å¾è¿›è¡ŒåŒ¹é…æ¨è"**

#### ğŸ“š åº”ç”¨åœºæ™¯
- **æ–°ç”¨æˆ·å†·å¯åŠ¨**: æ²¡æœ‰è¯„åˆ†å†å²æ—¶åŸºäºç”¨æˆ·ç‰¹å¾æ¨è
- **å†…å®¹ç›¸ä¼¼æ€§**: å›¾ä¹¦è¯¦æƒ…é¡µçš„å†…å®¹ç‰¹å¾ç›¸ä¼¼å›¾ä¹¦
- **é™çº§ç­–ç•¥**: ååŒè¿‡æ»¤å¤±è´¥æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ

#### ğŸ” ç‰¹å¾æå–ç»´åº¦

##### å›¾ä¹¦ç‰¹å¾ç»´åº¦
```python
å›¾ä¹¦ç‰¹å¾ = {
    'author': 'ä½œè€…åç§°',           # æƒé‡: 40%
    'publisher': 'å‡ºç‰ˆç¤¾',         # æƒé‡: 20%  
    'year': 'å‡ºç‰ˆå¹´ä»½',           # æƒé‡: 20%
    'avg_rating': 'å¹³å‡è¯„åˆ†',      # æƒé‡: 10%
    'title_keywords': 'æ ‡é¢˜å…³é”®è¯' # æƒé‡: 10%
}
```

##### ç”¨æˆ·ç‰¹å¾ç»´åº¦  
```python
ç”¨æˆ·ç‰¹å¾ = {
    'age': 'å¹´é¾„åå¥½',           # æƒé‡: 40%
    'country': 'æ–‡åŒ–èƒŒæ™¯',       # æƒé‡: 30%
    'location': 'åœ°ç†ä½ç½®',      # æƒé‡: 20%
    'rating_tendency': 'è¯„åˆ†å€¾å‘' # æƒé‡: 10%
}
```

#### ğŸ’» ç®—æ³•å®ç°

##### åŸºäºç”¨æˆ·ç‰¹å¾çš„å›¾ä¹¦æ¨è
```python
def recommend_by_user_features(self, user_info, top_n):
    for book in quality_books:
        match_score = 0.0
        
        # 1. å¹´é¾„åŒ¹é… (40%)
        if user_age < 25:
            age_score = 1.0 if book_year >= 2000 else 0.5  # å¹´è½»äººåå¥½æ–°ä¹¦
        elif user_age > 40:
            age_score = 1.0 if book_year <= 2000 else 0.8  # æˆç†Ÿè¯»è€…åå¥½ç»å…¸
        match_score += 0.4 * age_score
        
        # 2. æ–‡åŒ–åŒ¹é… (30%)
        if user_country in ['usa', 'uk', 'canada']:
            if 'è‹±è¯­ä½œè€…' in book_author:
                match_score += 0.3 * 0.8
        
        # 3. è´¨é‡åŒ¹é… (30%)
        quality_score = book_avg_rating / 5.0
        match_score += 0.3 * quality_score
        
        return sorted_by_match_score
```

##### åŸºäºå†…å®¹çš„å›¾ä¹¦ç›¸ä¼¼åº¦
```python
def calculate_book_content_similarity(self, book1, book2):
    similarity = 0.0
    
    # 1. ä½œè€…ç›¸ä¼¼åº¦ (50%)
    if book1.author == book2.author:
        similarity += 0.5
    
    # 2. å‡ºç‰ˆç¤¾ç›¸ä¼¼åº¦ (20%)  
    if book1.publisher == book2.publisher:
        similarity += 0.2
    
    # 3. å¹´ä»½ç›¸ä¼¼åº¦ (20%)
    year_diff = abs(book1.year - book2.year)
    year_similarity = max(0, 1 - year_diff / 20)  # 20å¹´å†…è®¤ä¸ºç›¸ä¼¼
    similarity += 0.2 * year_similarity
    
    # 4. è¯„åˆ†ç›¸ä¼¼åº¦ (10%)
    rating_diff = abs(book1.avg_rating - book2.avg_rating)
    rating_similarity = max(0, 1 - rating_diff / 2)
    similarity += 0.1 * rating_similarity
    
    return similarity
```

### 4. æ··åˆæ¨èç­–ç•¥ (Hybrid Recommendation)

#### ğŸ¯ æ ¸å¿ƒæ€æƒ³
**"æ™ºèƒ½ç»„åˆå¤šç§æ¨èç®—æ³•ï¼Œå–é•¿è¡¥çŸ­ï¼Œæä¾›æœ€ä¼˜æ¨èç»“æœ"**

#### ğŸ”„ æ··åˆç­–ç•¥å†³ç­–æ ‘

```
æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
â”œâ”€â”€ æœ‰è¯„åˆ†å†å² + æœ‰ç‰¹å¾ä¿¡æ¯
â”‚   â”œâ”€â”€ ååŒè¿‡æ»¤æˆåŠŸ + å†…å®¹ç‰¹å¾æˆåŠŸ â†’ 7:3æ··åˆ
â”‚   â”œâ”€â”€ åªæœ‰ååŒè¿‡æ»¤æˆåŠŸ â†’ çº¯ååŒè¿‡æ»¤
â”‚   â”œâ”€â”€ åªæœ‰å†…å®¹ç‰¹å¾æˆåŠŸ â†’ çº¯å†…å®¹ç‰¹å¾
â”‚   â””â”€â”€ ä¸¤è€…éƒ½å¤±è´¥ â†’ ä¼˜è´¨çƒ­é—¨å›¾ä¹¦
â”œâ”€â”€ æœ‰è¯„åˆ†å†å² + æ— ç‰¹å¾ä¿¡æ¯
â”‚   â”œâ”€â”€ ååŒè¿‡æ»¤æˆåŠŸ â†’ çº¯ååŒè¿‡æ»¤  
â”‚   â””â”€â”€ ååŒè¿‡æ»¤å¤±è´¥ â†’ ä¼˜è´¨çƒ­é—¨å›¾ä¹¦
â”œâ”€â”€ æ— è¯„åˆ†å†å² + æœ‰ç‰¹å¾ä¿¡æ¯
â”‚   â””â”€â”€ åŸºäºç”¨æˆ·ç‰¹å¾çš„å†…å®¹æ¨è
â””â”€â”€ æ— è¯„åˆ†å†å² + æ— ç‰¹å¾ä¿¡æ¯
    â””â”€â”€ å‰10æœ¬è¯„åˆ†æœ€é«˜ä¸”äººæ•°æœ€å¤šçš„å›¾ä¹¦
```

#### ğŸ’» æ··åˆç®—æ³•å®ç°

##### 7:3æ¯”ä¾‹æ··åˆ
```python
def mix_recommendations(self, cf_recs, content_recs, cf_ratio=0.7, total=10):
    cf_count = int(total * 0.7)      # ååŒè¿‡æ»¤: 7ä¸ª
    content_count = total - cf_count  # å†…å®¹ç‰¹å¾: 3ä¸ª
    
    # å»é‡ï¼šç§»é™¤åœ¨ååŒè¿‡æ»¤ä¸­å·²å­˜åœ¨çš„å›¾ä¹¦
    cf_book_ids = {rec['bookId'] for rec in cf_recs}
    filtered_content = [
        rec for rec in content_recs 
        if rec['bookId'] not in cf_book_ids
    ]
    
    # ç»„åˆç»“æœ
    mixed_result = []
    mixed_result.extend(cf_recs[:cf_count])
    mixed_result.extend(filtered_content[:content_count])
    
    return mixed_result
```

##### æ™ºèƒ½é™çº§å¤„ç†
```python
def get_hybrid_recommendations(self, user_id):
    # æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    has_ratings = check_user_ratings(user_id)
    has_features = check_user_features(user_id)
    
    if has_ratings and has_features:
        # æƒ…å†µ1: æœ€ç†æƒ³çŠ¶æ€ - æ··åˆæ¨è
        cf_recs = get_collaborative_filtering(user_id)
        content_recs = get_content_based(user_id)
        return mix_recommendations(cf_recs, content_recs, 0.7)
        
    elif has_ratings:
        # æƒ…å†µ2: æœ‰å†å²è¡Œä¸º - çº¯ååŒè¿‡æ»¤
        return get_collaborative_filtering(user_id)
        
    elif has_features:
        # æƒ…å†µ3: æ–°ç”¨æˆ·æœ‰ç‰¹å¾ - åŸºäºç‰¹å¾æ¨è
        return get_feature_based_recommendations(user_id)
        
    else:
        # æƒ…å†µ4: å®Œå…¨æ–°ç”¨æˆ· - çƒ­é—¨æ¨è
        return get_top_quality_books()
```

### 5. ç®—æ³•æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### ğŸš€ æ•°æ®åŠ è½½ä¼˜åŒ–

##### å¯åŠ¨æ—¶æ•°æ®åˆå§‹åŒ–
```python
# å¯åŠ¨æ—¶å…¨é‡åŠ è½½æ•°æ®åˆ°å†…å­˜
def initialize_data():
    ratings_df = load_ratings_data()      # 43ä¸‡æ¡è¯„åˆ†
    books_df = load_books_data()          # 15ä¸‡æœ¬å›¾ä¹¦
    users_df = load_users_data()          # 7ä¸‡ç”¨æˆ·
    last_update_time = datetime.now()
```

##### å¢é‡æ•°æ®æ›´æ–°
```python
# åç»­åªæŸ¥è¯¢æ–°å¢æ•°æ®
def get_incremental_data():
    new_ratings = SELECT * FROM ratings 
                 WHERE created_at > last_update_time
    
    if new_ratings:
        merge_and_deduplicate(new_ratings)
        update_cache()
```

#### âš¡ è®¡ç®—æ€§èƒ½ä¼˜åŒ–

##### å€™é€‰é¢„ç­›é€‰ç­–ç•¥
```python
# ç”¨æˆ·ååŒè¿‡æ»¤ï¼šä»7ä¸‡ç”¨æˆ·ç­›é€‰åˆ°å‡ åƒä¸ªå€™é€‰
target_books = ç”¨æˆ·è¯„åˆ†è¿‡çš„å›¾ä¹¦
candidate_users = ä¹Ÿè¯„åˆ†è¿‡è¿™äº›å›¾ä¹¦çš„ç”¨æˆ·  # å¤§å¹…å‡å°‘è®¡ç®—é‡

# ç‰©å“ååŒè¿‡æ»¤ï¼šä»23ä¸‡å›¾ä¹¦ç­›é€‰åˆ°å‡ åƒä¸ªå€™é€‰  
target_users = è¯„åˆ†è¿‡ç›®æ ‡å›¾ä¹¦çš„ç”¨æˆ·
candidate_books = è¿™äº›ç”¨æˆ·è¯„åˆ†è¿‡çš„å…¶ä»–å›¾ä¹¦  # å¤§å¹…å‡å°‘è®¡ç®—é‡

# å†…å®¹ç‰¹å¾ï¼šå¤šå±‚ç­›é€‰
åŒä½œè€…å›¾ä¹¦ + åŒå‡ºç‰ˆç¤¾å›¾ä¹¦ + ç›¸è¿‘å¹´ä»£å›¾ä¹¦ + é«˜è´¨é‡å›¾ä¹¦
```

##### æ‰¹é‡è®¡ç®—ä¼˜åŒ–
```python
# é¿å…é‡å¤æ•°æ®åº“æŸ¥è¯¢
candidate_ratings_grouped = candidate_ratings.groupby('book_id')

for book_id, book_ratings in candidate_ratings_grouped:
    # ç›´æ¥ä½¿ç”¨é¢„å¤„ç†æ•°æ®ï¼Œæ— éœ€é‡å¤æŸ¥è¯¢
    similarity = calculate_similarity(target, book_ratings)
```

#### ğŸ”„ ç¼“å­˜ç­–ç•¥è®¾è®¡

##### å¤šå±‚ç¼“å­˜æ¶æ„
```python
# 1. æ¨èç»“æœç¼“å­˜ (1å°æ—¶æœ‰æ•ˆæœŸ)
cache_file = f"models/cache/user_{user_id}_recommendations.json"
cache_data = {
    'recommendations': [...],
    'timestamp': time.time(),
    'algorithm': 'user_based_cf'
}

# 2. ç›¸ä¼¼åº¦è®¡ç®—ç¼“å­˜ (æ°¸ä¹…ç¼“å­˜)
similarity_cache[f"{book1_id}_{book2_id}"] = similarity_score

# 3. ç”¨æˆ·ç‰¹å¾ç¼“å­˜ (æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜)
user_features_cache[user_id] = user_basic_info
```

##### ç¼“å­˜å¤±æ•ˆç­–ç•¥
```python
# ç”¨æˆ·è¯„åˆ†åè‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
def on_user_rating(user_id, book_id, rating):
    # 1. æ¸…é™¤ç”¨æˆ·æ¨èç¼“å­˜
    clear_user_cache(user_id)
    
    # 2. æ¸…é™¤ç›¸å…³å›¾ä¹¦çš„ç›¸ä¼¼åº¦ç¼“å­˜
    clear_item_similarity_cache(book_id)
    
    # 3. å¼‚æ­¥é¢„è®¡ç®—æ–°æ¨è
    async_precompute_recommendations(user_id)
```

## ğŸ¯ ç®—æ³•åº”ç”¨åœºæ™¯å¯¹æ¯”

| ç®—æ³•ç±»å‹ | åº”ç”¨ä½ç½® | æ ¸å¿ƒé€»è¾‘ | é€‚ç”¨ç”¨æˆ· | æ¨èç‰¹ç‚¹ |
|---------|---------|---------|---------|---------|
| **ç”¨æˆ·ååŒè¿‡æ»¤** | æ¨èé¡µé¢ | æ‰¾ç›¸ä¼¼ç”¨æˆ·â†’æ¨èä»–ä»¬å–œæ¬¢çš„ä¹¦ | æœ‰è¯„åˆ†å†å²ç”¨æˆ· | å‘ç°æ–°å…´è¶£ï¼Œæ„å¤–æƒŠå–œ |
| **ç‰©å“ååŒè¿‡æ»¤** | å›¾ä¹¦è¯¦æƒ…é¡µ | æ‰¾ç›¸ä¼¼å›¾ä¹¦â†’æ¨èè¯„åˆ†æ¨¡å¼ç›¸ä¼¼çš„ä¹¦ | æ‰€æœ‰ç”¨æˆ· | æ·±åº¦æŒ–æ˜ï¼ŒåŒç±»æ¨è |
| **å†…å®¹ç‰¹å¾æ¨è** | å†·å¯åŠ¨åœºæ™¯ | ç”¨æˆ·ç‰¹å¾â†’å›¾ä¹¦ç‰¹å¾åŒ¹é… | æ–°ç”¨æˆ· | åŸºäºå±æ€§ï¼Œè§£é‡Šæ€§å¼º |
| **æ··åˆæ¨èç­–ç•¥** | æ™ºèƒ½ç»„åˆ | å¤šç®—æ³•èåˆâ†’æœ€ä¼˜ç»“æœ | æ‰€æœ‰åœºæ™¯ | å¹³è¡¡æ¢ç´¢ä¸å®‰å…¨æ€§ |

## ğŸ“Š ç®—æ³•è¯„ä¼°æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**: ç¼“å­˜å‘½ä¸­<1ç§’ï¼Œé¦–æ¬¡è®¡ç®—<30ç§’
- **å‡†ç¡®ç‡**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„æ¨èå‡†ç¡®æ€§
- **è¦†ç›–ç‡**: èƒ½å¤Ÿæ¨èçš„å›¾ä¹¦è¦†ç›–èŒƒå›´
- **å¤šæ ·æ€§**: æ¨èç»“æœçš„ç±»å‹ä¸°å¯Œåº¦

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡  
- **æ¨èè§£é‡Šæ€§**: æ¯ä¸ªæ¨èéƒ½æœ‰æ˜ç¡®ç†ç”±
- **å†·å¯åŠ¨å¤„ç†**: æ–°ç”¨æˆ·èƒ½ç«‹å³è·å¾—æ¨è
- **å®æ—¶æ€§**: è¯„åˆ†åæ¨èç«‹å³æ›´æ–°

## ğŸ”§ ç®—æ³•è°ƒä¼˜å‚æ•°

### ç›¸ä¼¼åº¦é˜ˆå€¼
```python
# ç”¨æˆ·ååŒè¿‡æ»¤
MIN_USER_SIMILARITY = 0.3      # ç”¨æˆ·ç›¸ä¼¼åº¦é˜ˆå€¼
MIN_COMMON_BOOKS = 2           # æœ€å°‘å…±åŒè¯„åˆ†å›¾ä¹¦

# ç‰©å“ååŒè¿‡æ»¤  
MIN_ITEM_SIMILARITY = 0.1      # å›¾ä¹¦ç›¸ä¼¼åº¦é˜ˆå€¼
MIN_COMMON_USERS = 2           # æœ€å°‘å…±åŒè¯„åˆ†ç”¨æˆ·

# æ··åˆæ¨è
CF_RATIO = 0.7                 # ååŒè¿‡æ»¤æƒé‡
CONTENT_RATIO = 0.3            # å†…å®¹ç‰¹å¾æƒé‡
```

### æ€§èƒ½å‚æ•°
```python
CACHE_DURATION = 3600          # ç¼“å­˜æœ‰æ•ˆæœŸ1å°æ—¶
MAX_CANDIDATES = 1000          # æœ€å¤§å€™é€‰æ•°é‡
BATCH_SIZE = 500               # æ‰¹å¤„ç†å¤§å°
```

## ğŸ’¡ ç®—æ³•åˆ›æ–°ç‚¹

### 1. å†…å­˜å®‰å…¨çš„ååŒè¿‡æ»¤
- **é—®é¢˜**: 7ä¸‡ç”¨æˆ·Ã—18ä¸‡å›¾ä¹¦çŸ©é˜µå¯¼è‡´å†…å­˜æº¢å‡º
- **è§£å†³**: åŸºäºDataFrameçš„å¢é‡è®¡ç®—ï¼Œé¿å…å¤§å‹çŸ©é˜µ
- **æ•ˆæœ**: å†…å­˜ä½¿ç”¨<500MBï¼Œæ”¯æŒå…¨é‡æ•°æ®å¤„ç†

### 2. å€™é€‰é¢„ç­›é€‰ä¼˜åŒ–
- **é—®é¢˜**: å…¨é‡è®¡ç®—æ—¶é—´å¤æ‚åº¦è¿‡é«˜
- **è§£å†³**: åŸºäºå…±åŒè¡Œä¸ºçš„å€™é€‰ç­›é€‰
- **æ•ˆæœ**: è®¡ç®—æ—¶é—´ä»å°æ—¶çº§â†’ç§’çº§

### 3. æ™ºèƒ½æ··åˆç­–ç•¥
- **é—®é¢˜**: å•ä¸€ç®—æ³•æ— æ³•å¤„ç†æ‰€æœ‰åœºæ™¯
- **è§£å†³**: åŸºäºç”¨æˆ·çŠ¶æ€çš„æ™ºèƒ½ç®—æ³•é€‰æ‹©
- **æ•ˆæœ**: è¦†ç›–æ‰€æœ‰ç”¨æˆ·ç±»å‹ï¼Œæ¨èè´¨é‡æœ€ä¼˜

### 4. å¼‚æ­¥é¢„è®¡ç®—æœºåˆ¶
- **é—®é¢˜**: å®æ—¶è®¡ç®—å½±å“ç”¨æˆ·ä½“éªŒ
- **è§£å†³**: è¯„åˆ†åå¼‚æ­¥é¢„è®¡ç®—ï¼Œç¼“å­˜çƒ­æ•°æ®
- **æ•ˆæœ**: æ¨èå“åº”æ—¶é—´<1ç§’

## ğŸ“ æ€»ç»“

æœ¬æ¨èç³»ç»ŸæˆåŠŸå®ç°äº†ï¼š
- **ç®—æ³•å®Œæ•´æ€§**: æ¶µç›–ååŒè¿‡æ»¤ã€å†…å®¹ç‰¹å¾ã€æ··åˆæ¨èçš„å®Œæ•´ç®—æ³•ä½“ç³»
- **å·¥ç¨‹å®ç”¨æ€§**: é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å·¥ç¨‹åŒ–å®ç°
- **ç”¨æˆ·ä½“éªŒ**: æ™ºèƒ½é™çº§ã€å®æ—¶å“åº”ã€ä¸ªæ€§åŒ–æ¨è
- **æŠ€æœ¯æ·±åº¦**: ç¬¦åˆæœ¬ç§‘æ¯•ä¸šè®¾è®¡çš„æŠ€æœ¯è¦æ±‚å’Œåˆ›æ–°æ€§

---

**ç®—æ³•ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¶é—´**: 2025-09-28  
**é€‚ç”¨å¯¹è±¡**: æ¨èç³»ç»Ÿå¼€å‘è€…ã€ç®—æ³•å·¥ç¨‹å¸ˆã€æ¯•ä¸šè®¾è®¡è¯„å®¡